<!DOCTYPE html> 
<html lang="pt-BR">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Pagamento LivePix</title>

 <style>
body {
 font-family: Arial, sans-serif;
 max-width: 500px;
 margin: 40px auto;
 padding: 20px;
}

input {
 display: block;
 width: 100%;
 padding: 10px;
 margin-top: 8px;
 border-radius: 6px;
 border: 1px solid #ccc;
}

.btn {
 background: #4f46e5;
 color: white;
 padding: 12px;
 border: none;
 width: 100%;
 border-radius: 6px;
 cursor: pointer;
 font-size: 16px;
 margin-top: 15px;
}

#mensagem {
 margin-top: 20px;
 padding: 12px;
 font-size: 15px;
 border-radius: 6px;
 display: none;
 white-space: pre-wrap; /* permite mostrar JSON formatado */
}

.erro {
 background: #ffdddd;
 color: #a70000;
}

.sucesso {
 background: #ddffdd;
 color: #006600;
}
 </style>
</head>
<body>

 <h2>Finalizar Compra</h2>

 <label>Valor do pagamento:</label>
 <input type="number" id="valor" value="7.90" step="0.01">

 <label style="margin-top:15px; display:block;">Descri√ß√£o:</label>
 <input type="text" id="descricao" value="Pagamento do produto">

 <button class="btn" id="btnComprar">Comprar</button>

 <div id="mensagem"></div>

 <script>
 document.getElementById("btnComprar").addEventListener("click", async () => {

 const valor = document.getElementById("valor").value;
 const descricao = document.getElementById("descricao").value;
 const msg = document.getElementById("mensagem");

 msg.style.display = "none";

 if (!valor || valor <= 0) {
    msg.textContent = "Defina um valor v√°lido.";
    msg.className = "erro";
    msg.style.display = "block";
    return;
 }

 try {
    msg.textContent = "Gerando pagamento...";
    msg.className = "sucesso";
    msg.style.display = "block";

    const resposta = await fetch("/.netlify/functions/gerar-pagamento", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          valor: Number(valor),
          descricao
        })
    });

    const data = await resposta.json();

    console.log("RETORNO LIVEPIX:", data);

    // üî• Mostra erro completo se LivePix deu erro
    if (data.erro) {
        msg.textContent = 
          "Erro: " + data.erro + 
          "\n\nDetalhe: " + JSON.stringify(data.motivo_real, null, 2);
        msg.className = "erro";
        msg.style.display = "block";
        return;
    }

    let linkPagamento = data.url;

    if (!linkPagamento) {
        msg.textContent = 
        "Erro: LivePix n√£o retornou um link de pagamento.\n\n" +
        "Detalhe: " + JSON.stringify(data, null, 2);
        msg.className = "erro";
        msg.style.display = "block";
        return;
    }

    window.location.href = linkPagamento;

 } catch (erro) {
    msg.textContent = "Erro ao criar pagamento: " + erro.message;
    msg.className = "erro";
    msg.style.display = "block";
 }
 });
 </script>

</body>
</html>
